---
- name: Generic Infrastructure
  remote_user: svc-ansible
  become: true
  hosts: all,!docker

  tasks:
  - name: Update apt cache
    tags:
    - always
    become: true
    when: ansible_pkg_mgr  == 'apt'
    apt:
      update_cache: true
      cache_valid_time: 3600

  - name: Generic configurations
    tags:
    - generic
    import_role:
      name: ansible-generic-os

  - name: Install platform tools
    tags:
    - generic
    - platform_tools
    import_role:
      name: ansible-role-hw_vm_tools

  - name: Install CA certificates
    import_role:
      name: ansible-role-cacerts
    tags:
    - generic
    - certs

####################################################################

- name: Authentication
  remote_user: svc-ansible
  become: true
  hosts: all,!docker
  vars_files:
  - vault.yml

  tasks:
  - name: Configure IPA client
    tags:
    - generic
    - ipa
    - auth
    import_role:
      name: ansible-role-ipaclient
    vars:
      # ipaclient_servers:
      # - ipa1.ipa.home.gatwards.org
      # - ipa2.ipa.home.gatwards.org
      ipaclient_domain: ipa.home.gatwards.org
      ipaclient_enroll_user: svc-ipajoin
      ipaclient_enroll_pass: "{{ vault_idm_admin_pass }}"
      ipaclient_sssd_shortnames: true
      ipaclient_krb5_dns_lookup_realm: 'true'
      ipaclient_krb5_dns_lookup_kdc: 'true'
      ipaclient_krb5_dns_canonicalize_hostname: 'true'
      ipaclient_krb5_extra_domains:
      - core.home.gatwards.org
      - .core.home.gatwards.org
      - lab.home.gatwards.org
      - .lab.home.gatwards.org

  - name: Add NFS domain to idmap.conf
    tags:
    - generic
    - ipa
    - auth
    lineinfile:
      path: /etc/idmapd.conf
      regexp: '^#?\s?Domain.*=.*'
      line: "Domain = home.gatwards.org"
      backrefs: true
      state: present

####################################################################

- name: Monitoring
  remote_user: svc-ansible
  hosts: all,!docker,!prometheus
  become: true

  tasks:
  - import_role:
      name: ansible-prometheus
    tags:
    - monitoring
    - node_exporter
    vars:
      prometheus_install: false
      prometheus_node_exporter_install: true
      prometheus_collector_____enabled_collectors:
      - 'collector.arp'
      - 'collector.bcache'
      - 'collector.bonding'
      - 'collector.cpu'
      - 'collector.cpufreq'
      - 'collector.edac'
      - 'collector.entropy'
      - 'collector.filefd'
      - 'collector.hwmon'
      - 'collector.ipvs'
      - 'collector.loadavg'
      - 'collector.mdadm'
      - 'collector.meminfo'
      - 'collector.netdev'
      - 'collector.netstat'
      - 'collector.nfs'
      - 'collector.nfsd'
      - 'collector.stat'
      - 'collector.time'
      - 'collector.vmstat'
      - 'collector.diskstats' # disabled by default
      - 'collector.filesystem' # disabled by default
      - 'collector.mountstats' # disabled by default
      - 'collector.systemd' # disabled by default
      - 'collector.textfile' # disabled by default

  - name: Open Prometheus node_exporter firewall port
    tags:
    - monitoring
    - node_exporter
    firewalld:
      port: '9100/tcp'
      immediate: yes
      permanent: yes
      state: enabled
